---
title: "Real Data (Summary)"
author: "Xi (Ada) Wang"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages and models, echo=FALSE,message=FALSE}
library(AugRCT)
library(readr) #read_csv
library(mice) #impute missing

root.path <- "C:\\Users\\wangxi8\\Documents\\AugRCT\\" 
```

### Trial Design
* __Current trial__ is KN-189:
    * study population: 1L non-squamous NSCLC.
    * E: pembrolizumab (MK-3475) + pemetrexed + platinum chemotherapy (carboplatin/cisplatin)
    * CD: saline placebo + pemetrexed + platinum chemotherapy (carboplatin/cisplatin)
* stratified randomization with the following factors:
    * PD-L1 expression: Tumor Proportion Score ≥1% vs <1%. (All PDL1TPS >= 1)
    * Platinum chemotherapy: cisplatin vs carboplatin.
    * Smoking status: never vs former/current. 

* __Historical trial__ is KN-042: 
    * study population: 1L NSCLC (non-squamous and squamous NSCLC) 
    * pembrolizumab (MK-3475) monotherapy vs. standard of care (SOC) platinum-based chemotherapy. 
    * CH: standard of care (SOC) platinum-based chemotherapy (carboplatin + paclitaxel or carboplatin + pemetrexe)
* stratified randomization with the following factors:
    * Geography: East Asia vs. non-East Asia
    * ECOG PS: 0 vs. 1
    * Histology: Squamous vs. non-squamous
    * PD-L1 Expression: TPS ≥50% vs. TPS 1-49% 
In order to make the two study populations similar, we __subset KN189 data__ to TPS>=1, and subset KN042 data to non-squamous patients only.

* NSCLC team statisitican: It's ok not to restrict the chemo choice in KN189 in this exercise.
* The “RCT” data corresponds to a 2:1 randomization scene (“Test” vs “Control”). For this real-data analysis, we augment the current control by doing the following:
    * keep all the patients in current trial (datasource=”RCT”): 128 CD (trt=”Control”) and 260 E (trt=”Test”).
    * randomly select 132 from 424 CH (datasource=”Historical”, trt=”Control”)

### Dataset Summary
* key variables 
    * trt (“Test” vs “Control”), 
    * data-source (datasource=”RCT” vs datasource=”Historical”), 
    * response (Overall Response; 1=patient responded and had a partial  (PR) or complete response (CR); 0=non-responder). 
* baseline covariates: 
    1. continuous 
        * AGE: baseline age?. Positive integer. range [31, 87] 
        * WEIGHTBL: baseline weight (kg). Positive number. range [37.3, 136.0]
        * BASETMR: baseline tumor size (mm). Positive number. range [10.4, 466.5]
    2. binary 
        * Male: = 1 if SEX="M", = 0 if SEX="F". SEX ("F"=Female, "M"=Male). 
        * White: = 1 if RACE=WHITE; = 0 otherwise. dichotomize "RACE".
        * PRAD_ind: = 1 if PRAD="Yes"; = 0 if PRAD="No". PRAD (Prior radiation therapy).
        * EastAsia: = 1 if REGEA="East Asia"; = 0 if REGEA="Non-East Asian".
        * PDL1TPS_50: = 1 if PDL1TPS >= 50; = 0 otherwise. dichotomize "PDL1TPS" (PD-L1 with tumor proportion score). 
        * BSECOG:(Baseline ECOG performance status). Levels (0, 1). "0" fully active. "1" Restricted in physically strenuous activity. 
        * CARBOPLATIN: = 1 if Platinum chemotherapy = carboplatin; = 0 if cisplatin.
        * Smoker: = 1 if SMOKER in ("Current","Former"); = 0 if "Never". (Smoking status)

* There is missing in covariate and outcome.  We create a "complete data" by __imputing missing__
    * in covariates with median for continuous variables and mode for categorical variables. (WEIGHTBL	BSECOG	White	BASETMR)   
Since the proportion of missing in covariates is low, it's likely that the imputation approach will not affect the results. No sensitivity analysis is needed for missing data


```{r,echo=F,message=FALSE,suppress=TRUE,warning=FALSE}
dt <- data.frame(read_csv(paste0(root.path, "\\Real data application\\analy_rct_external_ctrl_orr_23July2020.csv")))
contVars <- c("AGE", "WEIGHTBL", "BASETMR") #"PDL1TPS", 
binVars <- c("Male","White", "PRAD_ind","EastAsia","PDL1TPS_50", "BSECOG", "CARBOPLATIN","Smoker")
vars.all <- c(binVars,contVars)

dt <- dt %>% dplyr::mutate(group=ifelse(datasource=="RCT" & trt=="Test", "E",
                                        ifelse(datasource=="RCT" & trt=="Control", "CD",
                                               ifelse(datasource=="Historical" & trt=="Control", "CH",NA))),
                           D=1*(datasource=="RCT"), 
                           Z=1*(trt=="Test"),
                           Male=1*(SEX=="M"),
                           White=ifelse(is.na(RACE), NA, ifelse(RACE=="WHITE", 1,0)),
                           PRAD_ind=1*(PRAD=="Yes"),
                           EastAsia=1*(REGEA=="East Asia"),
                           PDL1TPS_50=1*(PDL1TPS>=50),
                           PDL1TPS_1=1*(PDL1TPS>=1),
                           STRATUMI=ifelse(is.na(STRATUMI),"CARBOPLATIN" ,STRATUMI),
                           Smoker=1*(SMOKER %in% c("Current","Former"))) %>% 
  dplyr::select(-RACE,-datasource, -trt)
library(stringr)
dt$CARBOPLATIN <- 1* (str_detect(dt$STRATUMI, "CARBOPLATIN"))
```

### Table: Missing Pattern 
* Each row represents a missing pattern. Each cell shows the indicator of missing in the corresponding column covariate.
* The last column is the number of patients in each missing pattern
* The last row is the number of patients with missing in the corresponding column covariate

```{r, echo=FALSE}
# check missing
miss.pattern <- data.frame(md.pattern(dt,plot=FALSE)[,18:21])
miss.pattern$N <- c(rownames(miss.pattern)[-7],sum(as.numeric(rownames(miss.pattern)), na.rm = T))
rownames(miss.pattern) <- c(paste0("Pattern ",c(1:6)),"Total") 
kableone(miss.pattern) 

# impute missing
# in outcome as non-responders (i.e. $Y=0$)
dt <- dt %>% dplyr::mutate(response=ifelse(is.na(response),0,response))
complete.dt <- NULL
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
for (i in c("E","CD","CH")){
    dt.temp <- dt %>% dplyr::filter(group==i)
    #impute with median (WEIGHTBL BASETMR)
    med.WEIGHTBL=median(dt.temp$WEIGHTBL,na.rm = T);med.BASETMR=median(dt.temp$BASETMR,na.rm = T)
    #impute with mode (BSECOG White)	
    mode.BSECOG=Mode(dt.temp$BSECOG);mode.White=Mode(dt.temp$White)
    dt.temp <- dt.temp %>% dplyr::mutate(White=ifelse(is.na(White),mode.White,White),BSECOG=ifelse(is.na(BSECOG),mode.BSECOG,BSECOG),
                                         WEIGHTBL=ifelse(is.na(WEIGHTBL),med.WEIGHTBL,WEIGHTBL),
                                         BASETMR=ifelse(is.na(BASETMR),med.BASETMR,BASETMR))
    complete.dt <- rbind(complete.dt,dt.temp)
}
complete.dt$group <- factor(complete.dt$group)
complete.dt$Y <- complete.dt$response
#complete.dt$CH.ind <- complete.dt$group=="CH"
save(complete.dt, file=paste0(root.path, "\\Real data application\\complete_realdata.RData"))
```



### Table 1.1 Descriptive Table (D (CD vs E) vs CH)

```{r,echo=FALSE}
table <- CreateTableOne(vars = c(vars.all),data = complete.dt, strata="group",factorVars = c(binVars))
kableone(table, nonnormal=contVars)
# kableone(table, format = "latex")
```

* response rate is 50.8% (132/260) in E, 24.2% (31/128) in CD, and 29.2% (124/424) in CH.
* P-values are reported from Kruskal-Wallis Rank Sum Test for continuous variables, and Chi-square test for categorical variables.

### Check correlation
* EastAsia and White are highly correlated with a p-value < 0.05 from both Chi-square test/Fisher's exact test. $R^2$ of logistic model with EastAsia as an outcome, adjusted for the rest predictors is 0.76. 
* We keep __White__ and remove EastAsia from the covariates in the propensity model
    * logit fit with EastAsia and the other covariates in the model: coefficient of EastAsia -3.51
    * logit fit with White and the other covariates in the model: coefficient of White 2.47
* Frequency Table with White(=1,=0) as rows, EastAsia (=1,=0) as columns
```{r correlation,echo=FALSE}
# check VIF (variance inflation factor). GVIF is calculated when df>=2
ps.covs.0=c("Smoker","AGE", "WEIGHTBL", "BASETMR","Male","White", "PRAD_ind","EastAsia","PDL1TPS_50", "BSECOG")#c(binVars,contVars)
ps.fml.0 <- as.formula(paste("D", "~", paste(ps.covs.0, collapse="+"), sep=""))
PS.fit.0 <- glm(ps.fml.0, data = complete.dt, family = "binomial")
#vif(PS.fit)

ps.fml.1 <- as.formula(paste("D", "~", paste(ps.covs.0[ps.covs.0 !="White"], collapse="+"), sep=""))
PS.fit.1 <- glm(ps.fml.1, data = complete.dt, family = "binomial")
#summary(PS.fit.1) #check logit fit

#check White and EastAsia
#round(cor(complete.dt[,c(contVars,binVars)],complete.dt[,c(contVars,binVars)]),1)

#chisq.test(complete.dt$White,complete.dt$EastAsia)
check.covs <- ps.covs.0[! ps.covs.0 %in% "EastAsia"]
check.fml <- as.formula(paste("EastAsia", "~", paste(check.covs, collapse="+"), sep=""))
check.fit <- glm(check.fml, data = complete.dt, family = "binomial")
#with(summary(check.fit), 1 - deviance/null.deviance) #R^2: proportion of residual errors explained by the model
table(complete.dt$White,complete.dt$EastAsia)
```

* Covariates: "Smoker","AGE", "WEIGHTBL", "BASETMR","Male", "PRAD_ind","White","PDL1TPS_50", "BSECOG"
* Model 1 In the PS model $logit(P(D=1)) \sim covariates$,
    * Significant terms (S, p < .05): Smoker, Male, White, BSECOG 
    * Significant terms (S, .05 < p < .1):  WEIGHTBL, BASETMR
    
* Model 2 In the model $logit(P(Z=1)) \sim covariates$,
    * S: Smoker, BASETMR, White, BSECOG 
    * S (.05 < p < .1):  WEIGHTBL, BASETMR
    
* Model 3 In the outcome model $logit(P(Y=1)) \sim covariates + Z + D$, 
    * S: Z, BASETMR, PDL1TPS_50, BSECOG
    * NS: D (tria indicator).

* Confounding (covariates related with both treatment and outcome): 
    * BASETMR, BSECOG (overlap in S between models 2.1 and 3.1)
    
```{r clean data,echo=FALSE}
ps.covs=c("Smoker","AGE", "WEIGHTBL", "BASETMR","Male", "PRAD_ind","White","PDL1TPS_50", "BSECOG")
#ps.covs=c("SMOKER","AGE", "WEIGHTBL", "BASETMR","Male", "PRAD_ind","EastAsia","PDL1TPS_50", "BSECOG")
ps.fml <- as.formula(paste("D", "~", paste(ps.covs, collapse="+"), sep=""))
PS.fit <- glm(ps.fml, data = complete.dt, family = "binomial")
ps.fml
summary(PS.fit) #check logit fit


ps.fml.Z <- as.formula(paste("Z", "~", paste(ps.covs, collapse="+"), sep=""))
PS.fit.Z <- glm(ps.fml.Z, data = complete.dt, family = "binomial")
ps.fml.Z
summary(PS.fit.Z) #check logit fit


mydata <- complete.dt
mydata$CH.ind <- mydata$group=="CH"
mydata$Y <- mydata$response

outcome.fml <- as.formula(paste("Y","~", paste(c(ps.covs,"Z","D"),collapse = "+"),sep=""))
outcome.fit <- glm(outcome.fml, data = mydata, family = "binomial")
outcome.fml
summary(outcome.fit)


#subgroup analysis by EastAsia, by White
mydata.EastAsia1 <- mydata[mydata$EastAsia==1,]
mydata.EastAsia0 <- mydata[mydata$EastAsia==0,]

mydata.White1 <- mydata[mydata$White==1,]
mydata.White0 <- mydata[mydata$White==0,]

mydata.CARBOPLATIN1 <- mydata[mydata$CARBOPLATIN==1,]
mydata.CARBOPLATIN0 <- mydata[mydata$CARBOPLATIN==0,]
```

## Figure 1: PS approach Diagnosis (By trial)
* We checked PS approach performance in all patients (figure 1A), White subgroup (figure 1.2). With two measures:
* PS distributional Balance
* Covariate Balance: (between two groups)
    * Standardized mean difference (>.1 indicates poor performance; use variance of treated group for ATT)
    * variance ratio (<.5 or >2 indicate poor performance)
* Conclusion:  
    * IPW approach has better performance than pair matching in balancing the covariates.
    * Covariates is more balanced between D=1 and D=0, also between Z=1 and Z=0 after PS approaches.
    * Figure 1A (All patients): Several covariates are poor balanced in pair matching: White, WEIGHTBL, Smoker, BSECOG. 
    * Figure 1B (White patients): Several covariates are poor balanced in pair matching: WEIGHTBL, Smoker, BSECOG, BASETMR.

### Figure 1A: All patients

```{r,echo=FALSE,message=FALSE,fig.width = 6, fig.height = 6}
res.freq <- RealData.Freq(realdata=mydata, ps.covs=ps.covs,
                    trt="D",nstrata = 5)
pm.mydata <- res.freq$pm.mydata
comp.freq <- res.freq$comp.freq
pm.mydata.check <- res.freq$pm.mydata.check
 
mydata.ps.check <- cbind(res.freq$mydata, IPW.weight=res.freq$mydata.iptw$weight, Match.weight= res.freq$pm.mydata.check$keep)

trt.vars = c("D","Z")
grp.var.labels = c("Trial","Treatment")
legend.labs <- c("Trial","Treatment")
i <- 1
#for (i in c(1)){
trt.var <- trt.vars[i]
grp.var.label <- grp.var.labels[i]
ps.fml.temp <- as.formula(paste(trt.var, "~", paste(ps.covs, collapse="+"), sep=""))
p <- bal.plot(ps.fml.temp, data=mydata.ps.check %>% dplyr::mutate(D=ifelse(D==1,"Current Trial", "Historical Trial")), treat=trt.var, weights = list(IPW="IPW.weight", Macthing="Match.weight"),distance="est.PS",binary = "std",
              s.d.denom="treated",stats = c("mean.diffs", "variance.ratios"),un=TRUE,thresholds = c(m = .1, v = 2),
              var.name = "est.PS", which = "both",
              type = "histogram", mirror = TRUE) + 
  labs(title = paste0("Distributional Balance of PS by ",grp.var.label),x="Estimated PS") + scale_fill_discrete(name =legend.labs[i] )
print(p)

ggsave(filename = "PS distribution.png", path = paste0(root.path, "Real data application\\Figure\\"), plot=p,
       width = 6, height = 4, dpi = 300, units = "in", device='png')
#knitr::include_graphics(paste0(paste0(root.path, "Real data application\\Figure\\"), "PS distribution.png"))

p <- love.plot(ps.fml.temp, data=mydata.ps.check, treat=trt.var, weights = list(IPW="IPW.weight", Macthing="Match.weight"),distance="est.PS",binary = "std", s.d.denom="treated",stats = "mean.diffs", #c("mean.diffs", "variance.ratios"), 
               un=TRUE,thresholds = c(m = .1, v = 2),
          var.order = "unadjusted", 
          abs = FALSE, # abs=TRUE. show absolute difference between two groups (absolute = true; abs(Standardized mean difference); 1/variance.ratio if variance.ratio<1)
          #colors = c("red", "blue", "darkgreen"), 
          #shapes = c("circle", "square", "triangle"),
          line = TRUE)
print(p)
ggsave(filename = "Covariate Balance.png", path = paste0(root.path, "Real data application\\Figure\\"), plot=p,
       width = 6, height = 4, dpi = 300, units = "in", device='png')
#knitr::include_graphics(paste0(paste0(root.path, "Real data application\\Figure\\"), "Covariate Balance.png"))
#}

```

### Figure 1.2:  White subgroup

```{r,echo=FALSE,message=FALSE}
res.freq <- RealData.Freq(realdata=mydata.White1, ps.covs=ps.covs[ps.covs !="White"],
                    trt="D",nstrata = 5)
pm.mydata <- res.freq$pm.mydata
comp.freq <- res.freq$comp.freq
pm.mydata.check <- res.freq$pm.mydata.check
mydata.ps.check <- cbind(res.freq$mydata, IPW.weight=res.freq$mydata.iptw$weight, Match.weight= res.freq$pm.mydata.check$keep)

trt.vars = c("D","Z")
grp.var.labels = c("Trial","Treatment")
legend.labs <- c("Trial","Treatment")
i <- 1
#for (i in c(1)){
  trt.var <- trt.vars[i]
  grp.var.label <- grp.var.labels[i]
  ps.fml.temp <- as.formula(paste(trt.var, "~", paste(ps.covs[ps.covs !="White"], collapse="+"), sep=""))
  
  p <- bal.plot(ps.fml.temp, data=mydata.ps.check %>% dplyr::mutate(D=ifelse(D==1,"Current Trial", "Historical Trial")), treat=trt.var, weights = list(IPW="IPW.weight", Macthing="Match.weight"),distance="est.PS",binary = "std",
           s.d.denom="treated",stats = c("mean.diffs", "variance.ratios"),un=TRUE,thresholds = c(m = .1, v = 2),
           var.name = "est.PS", which = "both",
           type = "histogram", mirror = TRUE) + 
    labs(title = paste0("Distributional Balance of PS by ",grp.var.label),x="Estimated PS") + scale_fill_discrete(name =legend.labs[i] )
  print(p)
  
  love.plot(ps.fml.temp, data=mydata.ps.check, treat=trt.var, weights = list(IPW="IPW.weight", Macthing="Match.weight"),distance="est.PS",binary = "std", s.d.denom="treated",stats = c("mean.diffs", "variance.ratios"),un=TRUE,thresholds = c(m = .1, v = 2),
            var.order = "unadjusted", 
            abs = FALSE, # abs=TRUE. show absolute difference between two groups (absolute = true; abs(Standardized mean difference); 1/variance.ratio if variance.ratio<1)
            #colors = c("red", "blue", "darkgreen"), 
            #shapes = c("circle", "square", "triangle"),
            line = TRUE)
#}

```

