---
title: "Real Data (RD)"
author: "Ada Wang"
date: "7/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages and models, echo=FALSE,message=FALSE}
library(AugRCT)
# path of the package
root.path <- "C:\\Users\\wangxi8\\Documents\\AugRCT\\" 
code.path <- paste0(root.path,"R\\")

#load Stan models
options(mc.cores=parallel::detectCores()) #In HPC server, DO NOT run this line of code
rstan_options(auto_write = TRUE) #tell stan not to compile code that has already been compiled
path <- paste0(root.path,"stan\\")
# Matching + Fixed power prior. Bayes model 1. logit(theta) =beta0 + lambda*Z
model.1 <- stan_model(paste0(path, "model1.stan"))
# Matching + Fixed power prior. Bayes model 2. theta ~ Beta(k*mu, k*(1-mu))
model.2 <- stan_model(paste0(path, "model2_new.stan"))
# Stratification + random Power Prior
model.3 <- stan_model(paste0(path, "model3.stan"))
# Stratification + fixed Power Prior
model.3fix <- stan_model(paste0(path, "model3fix.stan"))
# Matching + Commensurate prior
model.4 <- stan_model(paste0(path, "model4_new.stan"))

# PS stratification + Commensurate prior
model.5 <- stan_model(paste0(path, "model5_new.stan"))
# IPTW + Commensurate prior
model.6 <- stan_model(paste0(path, "model6_new.stan"))
```

```{r,echo=F,message=FALSE,suppress=TRUE,warning=FALSE}
kableone(head(complete.dt[,c("Y","Z","D","group",ps.covs)]))

ps.covs=c("Smoker","AGE", "WEIGHTBL", "BASETMR","Male", "PRAD_ind","White","PDL1TPS_50", "BSECOG")
ps.fml <- as.formula(paste("D", "~", paste(ps.covs, collapse="+"), sep=""))
PS.fit <- glm(ps.fml, data = complete.dt, family = "binomial")
#ps.fml
#summary(PS.fit) #check logit fit

mydata <- complete.dt

outcome.fml <- as.formula(paste("Y","~", paste(c(ps.covs,"Z","D"),collapse = "+"),sep=""))
outcome.fit <- glm(outcome.fml, data = mydata, family = "binomial")
#outcome.fml
#summary(outcome.fit)

#subgroup analysis by EastAsia, by White
mydata.EastAsia1 <- mydata[mydata$EastAsia==1,]
mydata.EastAsia0 <- mydata[mydata$EastAsia==0,]

mydata.White1 <- mydata[mydata$White==1,]
mydata.White0 <- mydata[mydata$White==0,]

mydata.CARBOPLATIN1 <- mydata[mydata$CARBOPLATIN==1,]
mydata.CARBOPLATINWhite1 <- mydata[mydata$CARBOPLATIN==1 & mydata$White==1,]

res.freq <- aug.control.freq.RD(mydata=mydata, ps.covs=ps.covs,
                    trt="D",nstrata = 5)
pm.mydata <- res.freq$pm.mydata
comp.freq <- res.freq$comp.freq
strat.trim.mydata <- res.freq$strat.trim.mydata
rwe.data <- res.freq$rwe.data
```

```{r stan, echo=F, eval=F}
data.list <- list(mydata, mydata.White1, mydata.CARBOPLATIN1)
ps.covs.list <- list(ps.covs, ps.covs[ps.covs!="White"], ps.covs) 
filenames <- c("RD_all","RD_SubgroupWhite","RD_SubgroupCARBOPLATIN")
nstratas <- c(5, 5, 5)

comps.all <- list()
for (i in 1:3){#length(data.list)){
  comp.tmp <- RealData.Hybrid(realdata=data.list[[i]], ps.covs=ps.covs.list[[i]],
                             trt="D",nstrata = nstratas[i])$comp
  comp.freq.tmp <- RealData.Freq(realdata=data.list[[i]], ps.covs=ps.covs.list[[i]],
                                   trt="D",nstrata = nstratas[i])$comp.freq
  comps1 <- comp.tmp %>% dplyr::mutate(point.est = mean, lower.CI = X2.5., upper.CI = X97.5.,label = fit) %>%
    dplyr::select(point.est,lower.CI,upper.CI,label)
  comp.all <- rbind(comps1, comp.freq.tmp) %>% dplyr::mutate_if(is.numeric, round, 3) %>% 
    arrange(label) %>% dplyr::mutate(CI.width = upper.CI - lower.CI) 
  rownames(comp.all)=c(1:nrow(comp.all))  
  comp.all <- comp.all %>% dplyr::mutate(relative.CI.width = CI.width/CI.width[comp.all$label=="No borrowing"])
  comps.all[[i]] <- comp.all
}
save(comps.all, file=paste0(root.path,"Real data application\\RealData_RD_08192020.RData"))
#save(comps.all, file=paste0(root.path,"Real data application\\RealData_RD_08032020.RData"))
#save(comps.all, file=paste0(root.path,"Real data application\\RealData_RD_07292020.RData"))
```

### Table 2. Results of All
* Hypothesis: $H_0: \triangle=\theta_E - \theta_C \leq 0  \text{  versus  } H_1: \triangle=\theta_E - \theta_C > 0$
    * reject $H_0$ if lower bound of $\triangle>0$
* row: each method
* columns: point estimate, 95% CI (confidence interval, or credible interval)
* estimates with current trial data only, and estimates with D and CH.


```{r, echo=FALSE,message=FALSE}
load(file=paste0(root.path,"Real data application\\RealData_RD_08192020.RData"))
remove.levels <- c("Stratification + fixed Power Prior","matching + power prior (Bayes model 1)")
levels <- levels(comps.all[[1]]$label)[-which(levels(comps.all[[1]]$label) %in% remove.levels)]
labels <- c("Matching + Power Prior", "Matching + Commensurate Prior",
            "Stratification + Power Prior", "Stratification + commensurate Prior",
            "IPTW + Power Prior","IPTW + commensurate Prior",
            "PS Matching","IPTW","Pooling",
            "No Borrowing", "IPTW Trimming", "PS Stratification")
order <- c("No Borrowing", "Pooling", 
           "PS Matching","Matching + Power Prior", "Matching + Commensurate Prior",
           "PS Stratification", "Stratification + Power Prior", "Stratification + commensurate Prior",
           "IPTW", "IPTW Trimming", "IPTW + Power Prior","IPTW + commensurate Prior")
for (i in 1: length(comps.all)){
  comps.all[[i]] <- comps.all[[i]] %>% 
  dplyr::filter(! label %in% remove.levels) %>%
    dplyr::mutate(label.new=factor(label, levels = levels, labels = labels))
  comps.all[[i]] <- comps.all[[i]] [match(order, labels),]
  rownames(comps.all[[i]])<- 1:dim(comps.all[[i]])[1]
  }

kableone(comps.all[[1]])
```

### Figure 2: Forest Plot of Treatment Effect (Above: RD; Below: relative CI width)
* x-axis is Risk Difference (RD) $\triangle=\theta_E-\theta_C$
* Boxsize is proportional to precision (i.e. inverse of variance, where variance is calculated treating the CI as Wald CI) $variance=(\frac{CI_U-CI_L}{2*qnorm(0.025)})^2$
* Conclusion: 
    * Point estimate: Response rate in CH (29.2\%) is higher than that in CD (24.2\%). Thus, in comparison with no borrowing, the point estimates of treatment effect using the other approaches change towards null. (response rate in E is 50.8\%)
    * Efficiency: with CI.width of no borroing as reference, the CI.width of the rest approaches is smaller (relative CI width < 1). Thus, there is efficiency gain borrowing information from CH.
```{r forest plot,echo=FALSE,message=FALSE,fig.width = 7, fig.height = 4}
clrs <- fpColors(box="royalblue",line="darkblue")
forestplot(labeltext=c(as.character(comps.all[[1]]$label.new)), 
           mean=c(comps.all[[1]]$point.est),
           lower=c(comps.all[[1]]$lower.CI),
           upper=c(comps.all[[1]]$upper.CI),
           grid = structure(c(0, comps.all[[1]]$point.est[comps.all[[1]]$label=="No borrowing"]), 
                            gp = gpar(lty = 2, col = "#CCCCFF")), 
           #zero=c(0,comps.all[[1]]$point.est[comps.all[[1]]$label=="No borrowing"]),
           xticks = seq(from=0,to=0.4,by=0.1),
           hrzl_lines = list("5"=gpar(lty=2)),
           txt_gp = fpTxtGp(ticks=gpar(cex=1),xlab=gpar(cex=1.0)), #change font size. label, summary, xlab, title, ticks and legend.
           xlab="Risk Difference (95% CI)",
           col=clrs,
           new_page = FALSE)

# relative CI width (with no borrowing as reference)
forestplot(labeltext=c(as.character(comps.all[[1]]$label.new)), 
           mean=c(comps.all[[1]]$relative.CI.width),
           lower=c(comps.all[[1]]$relative.CI.width),
           upper=c(comps.all[[1]]$relative.CI.width),
           zero=1.00,
           hrzl_lines = list("5"=gpar(lty=2)),
           boxsize = .25, # We set the box size to better visualize the type
           line.margin = .1, # We need to add this to avoid crowding
           txt_gp = fpTxtGp(ticks=gpar(cex=1),xlab=gpar(cex=1.0)), #change font size. label, summary, xlab, title, ticks and legend.
           xticks = seq(from=0.4,to=1,by=0.2),
           xlab="Relative CI Width \n (ref: No borrowing)",
           col=clrs)
```    

```{r save forest plot,echo=FALSE,message=FALSE}
setwd(paste0(root.path, "Real data application\\Figure\\"))
png(filename="RD_Estimate.png", width = 480*2, height = 480)#, width = 6, height = 6, res = 300, units = "in")
clrs <- fpColors(box="royalblue",line="darkblue")
library(grid)
grid.newpage()
borderWidth <- unit(4, "pt")
width <- unit(convertX(unit(1, "npc") - borderWidth, unitTo = "npc", valueOnly = TRUE)/3.5, "npc")
pushViewport(viewport(layout = grid.layout(nrow=1, 
                                           ncol=3, 
                                           widths = unit.c(2.5*width,
                                                           borderWidth,
                                                           width))
                      )
             )
pushViewport(viewport(layout.pos.row = 1,
                      layout.pos.col = 1))

forestplot(labeltext=c(as.character(comps.all[[1]]$label.new)), 
           mean=c(comps.all[[1]]$point.est),
           lower=c(comps.all[[1]]$lower.CI),
           upper=c(comps.all[[1]]$upper.CI),
           grid = structure(c(0, comps.all[[1]]$point.est[comps.all[[1]]$label=="No borrowing"]), 
                            gp = gpar(lty = 2, col = "#CCCCFF")), 
           #zero=c(0,comps.all[[1]]$point.est[comps.all[[1]]$label=="No borrowing"]),
           xticks = seq(from=0,to=0.4,by=0.1),
           hrzl_lines = list("3"=gpar(lty=1),"6"=gpar(lty=2),"9"=gpar(lty=2)),
           txt_gp = fpTxtGp(ticks=gpar(cex=1),xlab=gpar(cex=1.0)), #change font size. label, summary, xlab, title, ticks and legend.
           xlab="Response Rate Difference (95% CI)",
           col=clrs,
           new_page = FALSE)

upViewport()
pushViewport(viewport(layout.pos.row = 1,
                      layout.pos.col = 2))
grid.rect(gp = gpar(fill="#dddddd", col="#eeeeee"))
upViewport()
pushViewport(viewport(layout.pos.row = 1,
                      layout.pos.col = 3))

# relative CI width (with no borrowing as reference)
forestplot(labeltext=rep("",dim(comps.all[[1]])[1]), 
           mean=c(comps.all[[1]]$relative.CI.width),
           lower=c(comps.all[[1]]$relative.CI.width),
           upper=c(comps.all[[1]]$relative.CI.width),
           zero=1.00,
           hrzl_lines = list("3"=gpar(lty=1),"6"=gpar(lty=2),"9"=gpar(lty=2)),
           boxsize = .25, # We set the box size to better visualize the type
           line.margin = .1, # We need to add this to avoid crowding
           txt_gp = fpTxtGp(ticks=gpar(cex=1),xlab=gpar(cex=1.0)), #change font size. label, summary, xlab, title, ticks and legend.
           xticks = seq(from=0.4,to=1,by=0.2),
           xlab="Relative CI Width \n (ref: No borrowing)",
           col=clrs,
           new_page = FALSE)
upViewport(2)

dev.copy(png, "RD_Estimate.png")
suppressMessages( dev.off())

#knitr::include_graphics(paste0(root.path, "Real data application\\Figure\\","RD_Estimate.png"))
```

* Note: relative CI width < 1 in favor of the approach

### Table 3: Response rate \% (N) by group and PS Stratum

```{r,echo=FALSE,message=FALSE}
knitr::kable("(A) In PS stratification patients",col.names = "")
tab.response <- strat.trim.mydata %>% group_by(strata, group) %>% dplyr::summarise(response.rate = 100*round(mean(Y),2), n=n()) %>% dplyr::mutate(response.perc=paste0(response.rate,"%(",n,")")) %>% dplyr::select(-n, -response.rate) %>% 
  spread(strata, response.perc) %>% data.frame()
tab.response <- rbind( tab.response, c(NA,round(rwe.data$RS/sum(rwe.data$RS),3)))
rownames(tab.response) <- c(as.character(tab.response$group[1:3]), "Power Prior")
colnames(tab.response)[2:6] <- c(paste("Strata", 1:5))
kableone(tab.response%>% dplyr::select(-group))
```

### Figure 3: Forest Plot of Treatment Effect
### Figure 3A: Forest Plot of Treatment Effect (All vs. White Group vs. CARBOPLATIN Group)
* Conclusion: (relationship of point estimate of RD)
    * No matter what method or study population we used here, we reject the null hypothesis and demonstrate a significant positive treatment effect.
    * Comparing the subgroup analysis, we observe similar point estimates and CIs overall. Matching has the largest variability in the results among the four subgroup analyses. 
    * In general, no borrowing has a larger point estimate of RD compared with all the other approaches.
    * All vs All (Remove White from PS model): relationship of point estimate of RD
        * A noticable difference is abserved in "Matching" and "Matching + commensurate prior". Because the sparsed variable "White" drives the propensity model, which impacts how the patients are selected.
        * In frequentist approaches, 
        * In matching + Bayesian approaches, All > All (Remove White from PS model). Because response rate of CH in White  (Table 3B) < in White (remove White from PS model) (Table 3C).
        * In stratification + Bayesian approaches, All < All (Remove White from PS model). Because in table 4B (Remove White from PS model), sratatum 4 (with the highest response rate of CH) has the smallest power. Thus, point estimate of RD should be smaller in PS stratification + Bayesian of All (Remove White from PS model).

```{r,echo=FALSE,message=FALSE}
setwd(paste0(root.path, "Real data application\\Figure\\"))
png(filename="RD_Subgroup.png", width = 480*1.2, height = 480)#, width = 6, height = 6, res = 300, units = "in")
cols <- gg_color_hue(7)
forestplot(labeltext=c(as.character(comps.all[[1]]$label.new)), 
           legend = c("All", "White","CARBOPLATIN"),
           fn.ci_norm = c(fpDrawNormalCI, fpDrawCircleCI, fpDrawCircleCI),
           boxsize = .3, # We set the box size to better visualize the type
           line.margin = .05, # We need to add this to avoid crowding
           mean = cbind(c(comps.all[[1]]$point.est), 
                        c(comps.all[[2]]$point.est), c(comps.all[[3]]$point.est)),
           lower = cbind(c(comps.all[[1]]$lower.CI), 
                         c(comps.all[[2]]$lower.CI), c(comps.all[[3]]$lower.CI)),
           upper = cbind(c(comps.all[[1]]$upper.CI), 
                         c(comps.all[[2]]$upper.CI), c(comps.all[[3]]$upper.CI)),
           #clip =c(-.125, 0.075), #limit
           hrzl_lines = list("3"=gpar(lty=1),"6"=gpar(lty=2),"9"=gpar(lty=2)),
           zero=0,
           #xticks = seq(from=0,to=0.4,by=0.1),
           txt_gp = fpTxtGp(ticks=gpar(cex=1),xlab=gpar(cex=1.2)), #change font size. label, summary, xlab, title, ticks and legend.
           col=fpColors(box=c(cols[1],  cols[2],cols[3])),
           xlab="Response Rate Difference (95% CI)")
dev.off()

# code the same as above, for print purpose
forestplot(labeltext=c(as.character(comps.all[[1]]$label.new)), 
           legend = c("All", "White","CARBOPLATIN"),
           fn.ci_norm = c(fpDrawNormalCI, fpDrawCircleCI, fpDrawCircleCI),
           boxsize = .3, # We set the box size to better visualize the type
           line.margin = .05, # We need to add this to avoid crowding
           mean = cbind(c(comps.all[[1]]$point.est), 
                        c(comps.all[[2]]$point.est), c(comps.all[[3]]$point.est)),
           lower = cbind(c(comps.all[[1]]$lower.CI), 
                         c(comps.all[[2]]$lower.CI), c(comps.all[[3]]$lower.CI)),
           upper = cbind(c(comps.all[[1]]$upper.CI), 
                         c(comps.all[[2]]$upper.CI), c(comps.all[[3]]$upper.CI)),
           #clip =c(-.125, 0.075), #limit
           hrzl_lines = list("3"=gpar(lty=1),"6"=gpar(lty=2),"9"=gpar(lty=2)),
           zero=0,
           #xticks = seq(from=0,to=0.4,by=0.1),
           txt_gp = fpTxtGp(ticks=gpar(cex=1),xlab=gpar(cex=1.2)), #change font size. label, summary, xlab, title, ticks and legend.
           col=fpColors(box=c(cols[1],  cols[2],cols[3])),
           xlab="Response Rate Difference (95% CI)")
```

### Conclusion
In all the above approaches (except Non-White subgroup), we reject the null hypothesis and conclude that there is positive treatment effect on the overall response.
